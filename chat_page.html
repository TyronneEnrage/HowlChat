<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat Room</title>
    </head>

    <body>
        <div id = "UserInfo"></div>
        <button id="Logout">Log-out</button>

        <h2>Chat room</h2>
        <div id="ChatBox"></div>
        <form id="ChatForm">
            <input type="text" id="MessageInput" placeholder="Type Here" required>
            <button type="submit">Send</button>
        </form>
    </body>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBN2gdB0giH-cggQ9o50UNiOeXZkqJH9rc",
            authDomain: "howl-chat.firebaseapp.com",
            projectId: "howl-chat",
            storageBucket: "howl-chat.appspot.com",
            messagingSenderId: "611414212957",
            appId: "1:611414212957:web:f69082e890015bcfe0a8b4"
        }

        const webApp = initializeApp(firebaseConfig);
        const authentication = getAuth(webApp);
        const database = getFirestore(webApp);

        function initializeWebChat(user){
            console.log('Initializing chat for user:', user.displayName);
            document.getElementById('UserInfo').textContent = 'Logged in as ${user.displayName} (${user.email})';
            loadChatMessage();

            document.getElementById('ChatForm').addEventListener('submit', (e) => {e.preventDefault();
            const MessageInput = document.getElementById('MessageInput');
            const message = MessageInput.value.trim();
            if (message) {
                addMessage(user.displayName, message);
                MessageInput.value = '';
            }    
            })
        }

        onAuthStateChanged(auth, (user) => {
            if(user){
                initializeWebChat(user);
            } else {
                console.log('USer is not signed in, redirecting to the login page');
                window.location.href = 'index.html';
            }
        });

        document.getElementById('Logout').addEventListener('click', () => {
            signOut(authentication).then(() => {
                console.log('User Signed Out');
                window.location.href = 'index.html';
            }).catch ((error) => {
                console.error('Error signing out: ', error);
            });
        });

        async function addMessage(username, message){
            try{
                await addDoc(collection(database, 'messages'), {
                    name:username,
                    text: message,
                    timestamp: new Date()
                });
            } catch (error){
                console.error('Error adding message', error);
            }
        }

        function loadChatMessage(){
            const querychat = query(collection(database, 'messages'),
            orderBy('timestamp', 'asc'), limit(50));
            onSnapshot(querychat, (snapshot) => {
                const ChatBox = document.getElementById('ChatBox');
                ChatBox.innerHTML = '';

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('message');
                    messageElement,innerHTML = '<span class = Username>${data.name}</span>:${data.text}';
                    ChatBox.appendChild(messageElement);
                });
                ChatBox.scrollTop = ChatBox.scrollHeight;
            });
        }                       
    </script>
</html>         